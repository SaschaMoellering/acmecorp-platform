#!/bin/bash\n\n# CRaC Restore Script for AcmeCorp Platform Spring Boot Services\n# Usage: ./scripts/crac/restore.sh <service-name>\n\nset -euo pipefail\n\nSERVICE_NAME=${1:-}\n\nif [[ -z \"$SERVICE_NAME\" ]]; then\n    echo \"Usage: $0 <service-name>\"\n    echo \"Available services: gateway-service, orders-service, billing-service, notification-service, analytics-service\"\n    exit 1\nfi\n\n# Validate service name (Spring Boot only)\ncase \"$SERVICE_NAME\" in\n    gateway-service|orders-service|billing-service|notification-service|analytics-service)\n        ;;\n    *)\n        echo \"Error: '$SERVICE_NAME' is not a supported Spring Boot service\"\n        echo \"CRaC is only supported for Spring Boot services, not Quarkus services\"\n        exit 1\n        ;;\nesac\n\n# Get service port\ncase \"$SERVICE_NAME\" in\n    gateway-service) PORT=8080 ;;\n    orders-service) PORT=8081 ;;\n    billing-service) PORT=8082 ;;\n    notification-service) PORT=8083 ;;\n    analytics-service) PORT=8084 ;;\nesac\n\necho \"=== CRaC Restore ===\"\necho \"Service: $SERVICE_NAME\"\necho \"Port: $PORT\"\necho \"Date: $(date)\"\necho\n\n# Check if checkpoint volume exists\nVOLUME_NAME=\"crac-$SERVICE_NAME\"\nif ! docker volume inspect \"$VOLUME_NAME\" > /dev/null 2>&1; then\n    echo \"Error: Checkpoint volume '$VOLUME_NAME' not found\"\n    echo \"Please create a checkpoint first:\"\n    echo \"  ./scripts/crac/checkpoint.sh $SERVICE_NAME\"\n    exit 1\nfi\n\n# Check if checkpoint files exist\necho \"Checking checkpoint files...\"\nCHECKPOINT_CHECK=$(docker run --rm -v \"$VOLUME_NAME:/opt/crac\" alpine sh -c \"ls -la /opt/crac 2>/dev/null | wc -l\")\nif [[ \"$CHECKPOINT_CHECK\" -lt 2 ]]; then\n    echo \"Error: No checkpoint files found in volume '$VOLUME_NAME'\"\n    echo \"Please create a checkpoint first:\"\n    echo \"  ./scripts/crac/checkpoint.sh $SERVICE_NAME\"\n    exit 1\nfi\n\n# Stop any existing instance\ndocker stop \"$SERVICE_NAME\" 2>/dev/null || true\ndocker rm \"$SERVICE_NAME\" 2>/dev/null || true\n\necho \"Starting service from checkpoint...\"\n\n# Start container in restore mode\ndocker run -d \\\n    --name \"$SERVICE_NAME\" \\\n    --privileged \\\n    -p \"$PORT:$PORT\" \\\n    -e CRAC_MODE=restore \\\n    -e CRAC_CHECKPOINT_DIR=/opt/crac \\\n    -e SPRING_DATASOURCE_URL=\"jdbc:postgresql://host.docker.internal:5432/acmecorp\" \\\n    -e SPRING_DATASOURCE_USERNAME=\"acmecorp\" \\\n    -e SPRING_DATASOURCE_PASSWORD=\"acmecorp123\" \\\n    -e SPRING_RABBITMQ_HOST=\"host.docker.internal\" \\\n    -e SPRING_REDIS_HOST=\"host.docker.internal\" \\\n    -v \"$VOLUME_NAME:/opt/crac\" \\\n    \"$SERVICE_NAME:crac\"\n\n# Wait for service to be ready\necho \"Waiting for service to be ready...\"\nHEALTH_URL=\"http://localhost:$PORT/actuator/health\"\nSTART_TIME=$(date +%s)\n\nfor i in {1..30}; do\n    if curl -sf \"$HEALTH_URL\" > /dev/null 2>&1; then\n        END_TIME=$(date +%s)\n        STARTUP_TIME=$((END_TIME - START_TIME))\n        echo \"✅ Service restored and ready in ${STARTUP_TIME}s!\"\n        echo \"Health endpoint: $HEALTH_URL\"\n        echo \"Container: $SERVICE_NAME\"\n        echo\n        echo \"To stop the service:\"\n        echo \"  docker stop $SERVICE_NAME\"\n        exit 0\n    fi\n    sleep 1\ndone\n\necho \"❌ Service did not become ready within 30 seconds\"\necho \"Container logs:\"\ndocker logs \"$SERVICE_NAME\"\nexit 1