#!/bin/bash\n\n# CRaC Startup Benchmarking Script for AcmeCorp Platform\n# Usage: ./scripts/bench/crac-startup.sh [service-name] [iterations]\n\nset -euo pipefail\n\nSERVICE_NAME=${1:-\"orders-service\"}\nITERATIONS=${2:-3}\nTIMEOUT=${3:-60}\n\necho \"=== CRaC Startup Benchmark ===\"\necho \"Service: $SERVICE_NAME\"\necho \"Iterations: $ITERATIONS\"\necho \"Timeout: ${TIMEOUT}s\"\necho \"Branch: $(git branch --show-current)\"\necho \"Date: $(date)\"\necho\n\n# Validate service name (Spring Boot only)\ncase \"$SERVICE_NAME\" in\n    gateway-service|orders-service|billing-service|notification-service|analytics-service)\n        ;;\n    *)\n        echo \"Error: '$SERVICE_NAME' is not a supported Spring Boot service\"\n        echo \"CRaC is only supported for Spring Boot services\"\n        exit 1\n        ;;\nesac\n\n# Get service port\ncase \"$SERVICE_NAME\" in\n    gateway-service) PORT=8080 ;;\n    orders-service) PORT=8081 ;;\n    billing-service) PORT=8082 ;;\n    notification-service) PORT=8083 ;;\n    analytics-service) PORT=8084 ;;\nesac\n\nHEALTH_ENDPOINT=\"http://localhost:$PORT/actuator/health\"\necho \"Health endpoint: $HEALTH_ENDPOINT\"\necho\n\n# Check if CRaC image exists\nif ! docker images \"$SERVICE_NAME:crac\" --format \"{{.Repository}}\" | grep -q \"$SERVICE_NAME\"; then\n    echo \"Error: CRaC image '$SERVICE_NAME:crac' not found\"\n    echo \"Please build the image first:\"\n    echo \"  cd services/spring-boot/$SERVICE_NAME && docker build -t $SERVICE_NAME:crac .\"\n    exit 1\nfi\n\n# Check if checkpoint exists\nVOLUME_NAME=\"crac-$SERVICE_NAME\"\nif ! docker volume inspect \"$VOLUME_NAME\" > /dev/null 2>&1; then\n    echo \"Warning: Checkpoint volume '$VOLUME_NAME' not found\"\n    echo \"Will only benchmark normal JVM startup\"\n    BENCHMARK_CRAC=false\nelse\n    CHECKPOINT_CHECK=$(docker run --rm -v \"$VOLUME_NAME:/opt/crac\" alpine sh -c \"ls -la /opt/crac 2>/dev/null | wc -l\")\n    if [[ \"$CHECKPOINT_CHECK\" -lt 2 ]]; then\n        echo \"Warning: No checkpoint files found in volume '$VOLUME_NAME'\"\n        echo \"Will only benchmark normal JVM startup\"\n        BENCHMARK_CRAC=false\n    else\n        echo \"Checkpoint found, will benchmark both normal and CRaC startup\"\n        BENCHMARK_CRAC=true\n    fi\nfi\n\necho\n\n# Function to measure startup time\nmeasure_startup() {\n    local mode=$1\n    local iteration=$2\n    echo \"--- $mode - Iteration $iteration ---\"\n    \n    # Stop any existing container\n    docker stop \"$SERVICE_NAME-bench\" 2>/dev/null || true\n    docker rm \"$SERVICE_NAME-bench\" 2>/dev/null || true\n    \n    # Start timing\n    local start_time=$(date +%s.%N)\n    \n    # Start container based on mode\n    echo \"Starting container in $mode mode...\"\n    if [[ \"$mode\" == \"CRaC\" ]]; then\n        docker run -d --name \"$SERVICE_NAME-bench\" \\\n            --privileged \\\n            -p \"$PORT:$PORT\" \\\n            -e CRAC_MODE=restore \\\n            -e CRAC_CHECKPOINT_DIR=/opt/crac \\\n            -e SPRING_DATASOURCE_URL=\"jdbc:postgresql://host.docker.internal:5432/acmecorp\" \\\n            -e SPRING_DATASOURCE_USERNAME=\"acmecorp\" \\\n            -e SPRING_DATASOURCE_PASSWORD=\"acmecorp123\" \\\n            -e SPRING_RABBITMQ_HOST=\"host.docker.internal\" \\\n            -e SPRING_REDIS_HOST=\"host.docker.internal\" \\\n            -v \"$VOLUME_NAME:/opt/crac\" \\\n            \"$SERVICE_NAME:crac\" > /dev/null\n    else\n        docker run -d --name \"$SERVICE_NAME-bench\" \\\n            -p \"$PORT:$PORT\" \\\n            -e CRAC_MODE=off \\\n            -e SPRING_DATASOURCE_URL=\"jdbc:postgresql://host.docker.internal:5432/acmecorp\" \\\n            -e SPRING_DATASOURCE_USERNAME=\"acmecorp\" \\\n            -e SPRING_DATASOURCE_PASSWORD=\"acmecorp123\" \\\n            -e SPRING_RABBITMQ_HOST=\"host.docker.internal\" \\\n            -e SPRING_REDIS_HOST=\"host.docker.internal\" \\\n            \"$SERVICE_NAME:crac\" > /dev/null\n    fi\n    \n    # Wait for health endpoint\n    echo \"Waiting for health endpoint...\"\n    local ready=false\n    local elapsed=0\n    \n    while [[ $elapsed -lt $TIMEOUT ]]; do\n        if curl -sf \"$HEALTH_ENDPOINT\" > /dev/null 2>&1; then\n            ready=true\n            break\n        fi\n        sleep 0.1\n        elapsed=$((elapsed + 1))\n    done\n    \n    local end_time=$(date +%s.%N)\n    local startup_time=$(echo \"$end_time - $start_time\" | bc -l)\n    \n    if [[ \"$ready\" == \"true\" ]]; then\n        printf \"Startup time: %.3f seconds\\n\" \"$startup_time\"\n        \n        # Get memory usage\n        local memory_mb=$(docker stats --no-stream --format \"{{.MemUsage}}\" \"$SERVICE_NAME-bench\" | cut -d'/' -f1 | sed 's/MiB//' | sed 's/MB//' | tr -d ' ')\n        echo \"Memory usage: ${memory_mb}MB\"\n        \n        echo \"$startup_time\" >> \"/tmp/${SERVICE_NAME}_${mode,,}_startup_times.txt\"\n    else\n        echo \"TIMEOUT: Service did not become ready within ${TIMEOUT}s\"\n        startup_time=\"TIMEOUT\"\n    fi\n    \n    # Cleanup\n    docker stop \"$SERVICE_NAME-bench\" > /dev/null 2>&1 || true\n    docker rm \"$SERVICE_NAME-bench\" > /dev/null 2>&1 || true\n    \n    echo\n    return 0\n}\n\n# Check dependencies\nif ! command -v bc &> /dev/null; then\n    echo \"Error: 'bc' command not found. Please install bc for calculations.\"\n    exit 1\nfi\n\n# Clear previous results\nrm -f \"/tmp/${SERVICE_NAME}_normal_startup_times.txt\"\nrm -f \"/tmp/${SERVICE_NAME}_crac_startup_times.txt\"\n\n# Benchmark normal JVM startup\necho \"=== Benchmarking Normal JVM Startup ===\"\nfor i in $(seq 1 $ITERATIONS); do\n    measure_startup \"Normal\" $i\n    if [[ $i -lt $ITERATIONS ]]; then\n        echo \"Waiting 3 seconds before next iteration...\"\n        sleep 3\n    fi\ndone\n\n# Benchmark CRaC startup if available\nif [[ \"$BENCHMARK_CRAC\" == \"true\" ]]; then\n    echo \"=== Benchmarking CRaC Startup ===\"\n    for i in $(seq 1 $ITERATIONS); do\n        measure_startup \"CRaC\" $i\n        if [[ $i -lt $ITERATIONS ]]; then\n            echo \"Waiting 3 seconds before next iteration...\"\n            sleep 3\n        fi\n    done\nfi\n\n# Calculate and display results\necho \"=== BENCHMARK RESULTS ===\"\n\n# Normal JVM results\nif [[ -f \"/tmp/${SERVICE_NAME}_normal_startup_times.txt\" ]]; then\n    local normal_times=($(cat \"/tmp/${SERVICE_NAME}_normal_startup_times.txt\" | grep -v TIMEOUT))\n    local normal_count=${#normal_times[@]}\n    \n    if [[ $normal_count -gt 0 ]]; then\n        local normal_sum=0\n        for time in \"${normal_times[@]}\"; do\n            normal_sum=$(echo \"$normal_sum + $time\" | bc -l)\n        done\n        local normal_avg=$(echo \"scale=3; $normal_sum / $normal_count\" | bc -l)\n        \n        echo \"Normal JVM Startup:\"\n        printf \"  Average: %.3f seconds\\n\" \"$normal_avg\"\n        printf \"  Times: %s\\n\" \"${normal_times[*]}\"\n    fi\nfi\n\n# CRaC results\nif [[ \"$BENCHMARK_CRAC\" == \"true\" ]] && [[ -f \"/tmp/${SERVICE_NAME}_crac_startup_times.txt\" ]]; then\n    local crac_times=($(cat \"/tmp/${SERVICE_NAME}_crac_startup_times.txt\" | grep -v TIMEOUT))\n    local crac_count=${#crac_times[@]}\n    \n    if [[ $crac_count -gt 0 ]]; then\n        local crac_sum=0\n        for time in \"${crac_times[@]}\"; do\n            crac_sum=$(echo \"$crac_sum + $time\" | bc -l)\n        done\n        local crac_avg=$(echo \"scale=3; $crac_sum / $crac_count\" | bc -l)\n        \n        echo \"CRaC Startup:\"\n        printf \"  Average: %.3f seconds\\n\" \"$crac_avg\"\n        printf \"  Times: %s\\n\" \"${crac_times[*]}\"\n        \n        # Calculate improvement\n        if [[ $normal_count -gt 0 ]]; then\n            local improvement=$(echo \"scale=1; ($normal_avg - $crac_avg) / $normal_avg * 100\" | bc -l)\n            printf \"  Improvement: %.1f%% faster\\n\" \"$improvement\"\n        fi\n    fi\nfi\n\n# Save results\nlocal branch=$(git branch --show-current)\nlocal timestamp=$(date +%Y%m%d_%H%M%S)\nlocal results_file=\"crac_bench_${SERVICE_NAME}_${branch}_${timestamp}.txt\"\n\n{\n    echo \"Service: $SERVICE_NAME\"\n    echo \"Branch: $branch\"\n    echo \"Date: $(date)\"\n    echo \"Iterations: $ITERATIONS\"\n    if [[ $normal_count -gt 0 ]]; then\n        echo \"Normal JVM Average: ${normal_avg}s\"\n    fi\n    if [[ \"$BENCHMARK_CRAC\" == \"true\" ]] && [[ $crac_count -gt 0 ]]; then\n        echo \"CRaC Average: ${crac_avg}s\"\n        if [[ $normal_count -gt 0 ]]; then\n            echo \"Improvement: ${improvement}%\"\n        fi\n    fi\n} > \"$results_file\"\n\necho \"Results saved to: $results_file\"\n\n# Cleanup\nrm -f \"/tmp/${SERVICE_NAME}_normal_startup_times.txt\"\nrm -f \"/tmp/${SERVICE_NAME}_crac_startup_times.txt\"\n\necho\necho \"Benchmark complete!\"